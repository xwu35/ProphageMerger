# ProphageMerger

ProphageMerger is a Snakemake workflow designed to predict prophage regions in bacterial genomes using a combination of tools ([VirSorter2](https://github.com/jiarong/VirSorter2) v2.2.4 + [CheckV](https://bitbucket.org/berkeleylab/checkv/src/master/) v1.0.3, [GeNomad](https://github.com/apcamargo/genomad) v1.11.1 and [VIBRANT](https://github.com/AnantharamanLab/VIBRANT) v1.2.1). CheckV is run after VirSorter2, using the output file generated by VirSorter2. Predicted regions that overlap within 10 kb are merged, with the minimum start coordinate and maximum end coordinate selected for each merged region. The resulting maximized prophage regions are intended for use in the viral tagging analysis. The sequences of the maximized prophage regions are extracted and evaluated using CheckV. 

## Set up environment

### Clone the repository 

```bash
git clone https://github.com/xwu35/ProphageMerger.git
```

### Install Snakemake

ProphageMerger is built for Snakemake version 7. Version 8 and above introduce breaking changes and deprecations and have not been tested. It may not function correctly with newer versions. Please install Snakemake version 7 using the script below.

```bash
cd ProphageMerger

# option 1 using conda
conda env create -n snakemake -f snakemake_env.yml

# option 2 using mamba if it's installed
mamba env create -n snakemake -f snakemake_env.yml
```

If you have installed Snakemake version 7 on your system without using the commands above, make sure that `Biopython` is also installed. If it is not already installed, activate your snakemake environment and run `pip install biopython==1.86`.

### Move snakemake profile

The profile is required to run the workflow on HPC.

```bash
# move the profile to the right directory
mv slurm ~/.config/snakemake 

# if the slurm directory was already moved to ~/.config/snakemake from a previous download, delete it from the repository directory to avoid potential errors
rm -r slurm
```

## Usage

ProphageMerger requires a FASTA file of the chromosome sequences, which may consist of a single contig or multiple contigs. Due to the purge policy of the scratch partition on the server, you can store the installed tools and downloaded databases in a directory that is not subject to purging by specifying the options `--conda_envs path/to/store/tools` and `--database path/to/store/databases`. Detailed usage information can be viewed using the -h or --help flags `python ProphageMerger.py -h`.

### dry run 

A dry-run can be performed to check which rules will be executed and which files will be produced. 

```bash
conda activate snakemake

python ProphageMerger.py \
    -g test_data/genome_sequences.fa \
    -o test_output \
    --dryrun
```

### Run test data

Do not run this on the login node. Submit it as an sbatch job on the HPC using `sbatch run_prophagemerger.sh`. Make sure to update the --mail-user field before submitting the job.

```bash
conda activate snakemake

python ProphageMerger.py \
    -g test_data/genome_sequences.fa \
    -o test_output
```

## Output description

- **output_dir/results/all_coordinates.txt**: Predicted prophage coordinates from all tools
- **output_dir/results/final_coordinates.txt**: Maximized prophage coordinates after merging
- **output_dir/results/final_coordinates_0-based.bed**: Same as final_coordinates.txt, but this version has been converted to 0-based coordinates. It can be used as input for [VTPhageFinder](https://github.com/xwu35/VTPhageFinder)
- **output_dir/results/prophage_region_sequences.fa**: Sequences of the final prophage regions
- **output_dir/results/checkv_evaluation/quality_summary.tsv**: Prophage region completeness


## Merge predicted prophage regions

If the prediction tools have already been executed elsewhere without using this pipeline, and you only need to merge the predicted regions, you can use the `combine_prophage_coordinates.py` script. Detailed usage information can be viewed using the -h or --help flags `python workflow/scripts/combine_prophage_coordinates.py -h`.

```bash
conda activate snakemake 

python workflow/scripts/combine_prophage_coordinates.py \
     --virsorter2 path/to/final-viral-boundary.tsv \
     --checkv path/to/proviruses.fna  \
     --genomad path/to/prefix_provirus.tsv \
     --vibrant path/to/VIBRANT_integrated_prophage_coordinates_prefix.tsv \
     --all_coordinates all_coordinates.txt \
     --final_coordinates final_coordinates.txt \
     --bed_file final_coordinates_0-based.bed
```